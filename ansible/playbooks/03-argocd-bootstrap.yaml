# /ansible/playbooks/03-argocd-bootstrap.yaml
---
- name: Bootstrap ArgoCD (GitOps Engine)
  hosts: localhost
  become: no
  gather_facts: yes # RETTELSE: Skal være yes for at læse ansible_env korrekt
  vars:
    # JEg bruger standard config placeringen
    kubeconfig_path: "{{ ansible_env.HOME }}/.kube/config"
    repo_path: "/opt/bachelor-gitops"
    
  tasks:
    - name: 1. Opret ArgoCD Namespace
      ansible.builtin.shell: |
        kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # NYT TRIN: Download filen med tvungen IPv4 (curl -4) for at omgå IPv6 timeout
    - name: 2. Download ArgoCD Manifest
      ansible.builtin.shell: |
        curl -4 -sSL -o /tmp/argocd-install.yaml https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

    - name: 3. Installer ArgoCD (Fra lokal fil)
      ansible.builtin.shell: |
        kubectl apply -n argocd -f /tmp/argocd-install.yaml
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      # Jeg tilføjer retries for at håndtere API-server belastning
      register: install_result
      until: install_result.rc == 0
      retries: 5
      delay: 10

    - name: 4. Vent på at ArgoCD Server er klar (Dette kan tage tid)
      ansible.builtin.shell: |
        kubectl wait --for=condition=Ready pods --all -n argocd --timeout=300s
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      # Jeg ignorerer fejl første gang, da pods måske ikke er skabt endnu
      register: result
      until: result.rc == 0
      retries: 20
      delay: 15

    - name: 5. Patch ArgoCD Server til NodePort (For ekstern adgang)
      ansible.builtin.shell: |
        kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "NodePort"}}'
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      # --- BOOTSTRAP AF APPLIKATIONER (NYT) ---
    - name: 6. Aktiver Kubernetes Dashboard
      ansible.builtin.shell: |
        kubectl apply -f {{ repo_path }}/kubernetes/system-apps/dashboard.yaml
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
    - name: 7. Aktiver GitOps Pipeline (Forbind til GitHub)
      # Dette step starter 'App of Apps' og dermed alle miljøer (DEV, TST, PRD etc.)
      ansible.builtin.shell: |
        kubectl apply -f {{ repo_path }}/kubernetes/argocd-apps/all-envs.yaml
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
    - name: 8. Find NodePort Portnummer
      ansible.builtin.shell: |
        kubectl get svc argocd-server -n argocd -o jsonpath='{.spec.ports[?(@.name=="https")].nodePort}'
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: argocd_port
    - name: 9. Hent Initial Admin Password
      ansible.builtin.shell: |
        kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: argocd_password
    - name: 10. Opret Dashboard Token (Til login)
      ansible.builtin.shell: |
        kubectl -n kubernetes-dashboard create token admin-user
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: dashboard_token
      ignore_errors: yes # Hvis dashboard ikke er helt oppe endnu

    - name: 11. VIS ADGANGSDATA (Gem disse!)
      ansible.builtin.debug:
        msg: 
          - "--------------------------------------------------------"
          - "ARGO CD ER INSTALLERET OG FORBUNDET TIL GITHUB"
          - "--------------------------------------------------------"
          - "ArgoCD URL:   https://192.168.8.101:{{ argocd_port.stdout }}"
          - "ArgoCD User:  admin"
          - "ArgoCD Pass:  {{ argocd_password.stdout }}"
          - "--------------------------------------------------------"
          - "Dashboard Token:"
          - "{{ dashboard_token.stdout }}"
          - "--------------------------------------------------------"